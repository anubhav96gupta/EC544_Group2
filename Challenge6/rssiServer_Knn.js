var SerialPort = require("serialport");
var app = require('express')();
var xbee_api = require('xbee-api');
var KNN = require('ml-knn');

var express = require('express')();
var http = requre('http').Server(app);
var io = require('socket.io')(http);

app.use('/fonts', express.static(__dirname + 'frontend/fonts'));
app.use('/images', express.static(__dirname + '/frontend/images'));
app.use('/', express.static(__dirname + '/frontend'));


app.get('/localization', function(req, res){
  res.sendfile('frontend/index.html');
});

//var csvWriter = require('csv-write-stream')
var fs = require('fs')
//var writer = csvWriter()
//writer.pipe(fs.createWriteStream('47.csv'));

var C = xbee_api.constants;
var XBeeAPI = new xbee_api.XBeeAPI({
  api_mode: 2
});

//var c = 1;
var count = 0;
var flag = [0,0,0,0];
var portName = process.argv[2];
var knn = new KNN();

var sampleDelay = 2000;
var dataset = [[0, 0, 0, 0]]

//Note that with the XBeeAPI parser, the serialport's "data" event will not fire when messages are received!
portConfig = {
	baudRate: 9600,
  parser: XBeeAPI.rawParser()
};

// Connecting to the HTTP server and telling the code where to listen for incoming connections
// and where to send outgoing connections
io.on('connection', function(socket){
  console.log('a user connected');
  socket.on('disconnect', function(){
  });
});

http.listen(4000, function(){
  //listen on localhost port 4000
  console.log('listening on *:4000');
});


var train = [
              [40,35,63,68],
[40,45,65,72],
[57,42,71,83],
[43,40,74,72],
[45,38,65,75],
[47,34,68,77],
[40,45,69,79],
[67,46,55,70],
[50,43,77,75],
[42,36,80,72],
[50,33,69,72],
[45,44,71,72],
[46,41,64,81],
[49,55,63,72],
[44,46,61,73],
[41,38,67,74],
[47,38,72,71],
[54,44,71,79],
[48,40,68,75],
[46,42,70,81],
[67,54,63,79],
[48,43,72,76],
[54,62,64,78],
[54,61,63,75],
[49,44,67,81],
[55,43,62,76],
[54,43,63,85],
[52,47,66,75],
[52,57,60,71],
[51,48,69,82],
[63,40,58,73],
[55,37,69,73],
[70,44,64,74],
[49,47,59,73],
[45,46,60,78],
[53,44,56,73],
[48,42,74,75],
[51,46,62,78],
[60,45,63,76],
[57,48,61,71],
[72,45,57,75],
[53,52,73,81],
[51,50,62,70],
[55,50,57,71],
[51,47,62,70],
[62,45,66,72],
[54,60,57,75],
[54,43,65,73],
[49,55,63,73],
[66,43,69,81],
[49,56,61,82],
[69,47,60,74],
[48,60,65,77],
[47,49,60,81],
[54,49,58,77],
[52,52,63,70],
[54,53,56,70],
[61,44,67,80],
[51,48,60,79],
[53,59,64,75],
[56,64,54,75],
[48,52,60,74],
[61,61,60,71],
[54,45,55,74],
[65,53,69,72],
[55,47,67,85],
[53,42,69,72],
[59,41,61,74],
[63,47,65,76],
[57,50,70,70],
[57,45,57,73],
[53,41,63,78],
[57,43,63,78],
[58,52,66,71],
[66,47,57,79],
[64,46,55,77],
[54,57,63,79],
[54,47,70,75],
[51,47,65,75],
[54,48,68,70],
[57,66,70,73],
[62,63,57,72],
[55,63,57,71],
[61,49,52,74],
[54,51,61,70],
[60,49,62,75],
[54,48,59,73],
[54,49,69,76],
[65,52,57,71],
[58,52,64,72],
[62,47,73,75],
[59,57,59,75],
[60,50,62,74],
[63,66,58,71],
[64,50,55,67],
[60,45,65,84],
[57,48,63,77],
[59,53,61,73],
[64,60,62,75],
[58,56,57,72],
[75,52,64,74],
[63,64,61,75],
[72,56,64,82],
[64,54,59,74],
[57,60,57,76],
[55,57,67,76],
[65,56,59,74],
[60,61,61,71],
[63,56,58,71],
[60,49,55,69],
[56,54,66,82],
[55,51,71,77],
[69,59,65,86],
[68,59,59,68],
[64,55,61,66],
[58,68,54,80],
[61,58,66,78],
[60,51,57,70],
[63,52,57,79],
[59,54,58,75],
[77,59,63,69],
[63,68,59,72],
[63,56,76,80],
[76,62,55,74],
[57,55,58,74],
[60,59,61,71],
[69,62,69,76],
[66,51,62,70],
[65,57,58,74],
[79,61,62,72],
[69,62,52,70],
[61,54,65,69],
[63,63,65,71],
[59,54,64,73],
[68,63,63,66],
[73,63,55,70],
[58,57,60,74],
[60,58,63,78],
[60,56,70,75],
[64,58,72,73],
[67,68,61,65],
[66,69,61,78],
[81,64,58,66],
[63,62,59,67],
[72,54,51,69],
[63,52,54,77],
[57,53,66,80],
[75,57,59,68],
[72,65,59,67],
[70,62,64,71],
[67,60,57,67],
[71,65,55,75],
[60,58,68,73],
[59,52,63,66],
[57,56,65,73],
[64,68,52,71],
[71,61,60,69],
[77,73,60,72],
[61,51,61,79],
[64,65,58,74],
[67,62,57,63],
[75,64,56,69],
[71,64,61,71],
[62,60,54,63],
[63,57,60,68],
[75,59,66,74],
[66,55,60,68],
[63,64,53,69],
[72,60,65,76],
[62,66,46,70],
[57,54,51,66],
[60,66,59,73],
[66,62,57,80],
[60,60,73,66],
[63,61,56,61],
[71,71,46,77],
[74,69,56,67],
[63,57,52,79],
[64,61,64,73],
[68,57,53,67],
[77,63,49,68],
[69,58,54,67],
[70,60,58,68],
[69,70,48,67],
[72,55,54,64],
[65,58,70,83],
[62,55,57,85],
[59,67,51,64],
[66,63,63,67],
[76,65,48,63],
[72,63,48,63],
[67,68,69,70],
[69,59,58,67],
[57,60,57,75],
[71,63,54,71],
[61,64,53,63],
[75,63,50,60],
[71,62,47,62],
[71,61,48,81],
[62,72,57,62],
[67,69,50,75],
[67,63,54,75],
[69,62,59,73],
[74,59,50,72],
[69,71,49,71],
[64,65,50,68],
[68,58,64,71],
[62,59,56,65],
[77,65,59,72],
[65,60,54,66],
[70,69,50,67],
[72,59,47,68],
[76,61,49,65],
[75,63,66,87],
[65,78,57,68],
[75,61,55,68],
[83,63,57,67],
[73,70,49,74],
[79,72,46,71],
[73,61,49,65],
[75,68,48,60],
[70,61,52,67],
[72,66,48,73],
[72,70,48,59],
[75,75,64,62],
[81,60,58,57],
[63,55,55,62],
[66,57,58,80],
[76,60,53,74],
[77,61,53,65],
[66,65,55,64],
[61,63,57,68],
[73,62,50,69],
[81,64,56,63],
[69,72,55,75],
[71,61,51,66],
[66,63,61,65],
[75,69,53,64],
[73,62,60,57],
[69,61,57,68],
[86,69,49,65],
[76,68,52,66],
[74,71,60,60],
[76,71,52,69],
[70,74,52,66],
[74,64,52,81],
[66,65,48,69],
[67,53,54,66],
[63,57,51,65],
[70,60,54,62],
[78,72,48,60],
[67,57,48,58],
[68,69,52,58],
[64,60,56,64],
[67,56,51,65],
[70,63,50,67],
[67,57,54,70],
[67,59,49,69],
[69,78,55,63],
[78,71,57,68],
[67,68,42,54],
[67,70,45,57],
[74,59,48,71],
[75,68,47,57],
[81,64,43,67],
[76,62,63,57],
[67,59,54,58],
[68,61,57,72],
[65,55,53,60],
[63,55,52,67],
[74,73,48,60],
[74,73,47,51],
[77,63,42,56],
[73,68,61,66],
[69,57,67,58],
[66,58,54,65],
[67,62,50,71],
[77,58,46,58],
[74,53,58,60],
[74,69,61,62],
[70,60,44,63],
[78,71,51,64],
[82,66,55,65],
[72,80,39,71],
[74,63,50,57],
[69,59,63,62],
[73,57,46,63],
[68,56,49,62],
[84,73,44,64],
[64,59,50,55],
[77,83,57,58],
[69,74,51,59],
[67,63,58,66],
[69,60,51,58],
[81,63,43,71],
[73,66,50,54],
[69,69,48,62],
[64,57,51,57],
[79,62,47,57],
[68,70,62,66],
[77,68,47,55],
[69,71,50,53],
[73,73,36,52],
[73,67,49,61],
[72,66,47,55],
[67,59,45,61],
[70,65,60,61],
[70,60,41,49],
[69,59,40,60],
[69,67,46,65],
[73,70,49,75],
[65,59,47,56],
[74,65,53,51],
[73,58,43,63],
[67,64,43,55],
[76,68,39,57],
[73,77,43,54],
[74,63,49,59],
[74,64,40,58],
[70,60,43,66],
[69,61,40,61],
[68,65,64,59],
[81,72,37,61],
[80,63,46,70],
[67,58,39,59],
[68,61,47,58],
[73,60,49,53],
[73,63,36,55],
[81,60,38,55],
[75,68,36,64],
[70,62,37,58],
[66,65,46,55],
[69,62,46,69],
[73,59,45,57],
[80,68,46,65],
[77,70,39,50],
[77,57,47,60],
[67,60,39,73],
[78,70,44,61],
[80,60,41,56],
[68,69,42,49],
[78,70,41,48],
[77,64,42,45],
[72,67,35,54],
[70,72,35,48],
[63,66,48,58],
[67,73,40,60],
[70,68,37,54],
[76,79,34,50],
[74,66,36,58],
[75,63,37,50],
[77,79,41,57],
[73,68,41,55],
[80,81,39,48],
[84,72,43,45],
[79,67,39,47],
[77,69,38,46],
[77,73,35,46],
[79,70,37,54],
[82,82,37,59],
[70,74,36,42],
[81,76,39,47],
[80,73,42,46],
[82,72,42,45],
[82,67,42,47],
[69,60,35,54],
[70,68,37,59],
[71,73,39,58],
[83,75,36,47],
[73,66,36,60],
[65,63,50,57],
[78,79,38,50],
[77,61,40,52],
[69,61,39,51],
[74,60,36,51],
[77,74,37,42],
[74,73,42,47],
[81,69,47,48],
[76,69,36,41],
[73,66,39,54],
[76,82,56,39],
[81,77,60,55],
[82,79,42,45],
[78,75,45,51],
[82,75,40,40],
[79,72,38,50],
[83,72,42,43],
[86,76,40,51],
[76,80,58,41],
[77,70,41,43],
[73,73,51,49],
[81,66,36,53],
[76,83,43,40],
[78,74,40,43],
[81,67,47,59],
[75,69,43,45],
[86,79,41,58],
[72,83,46,44],
[73,81,44,44],
[80,76,44,55],
             [83,75,48,52],[76,82,45,52],[83,79,46,57],[83,70,49,40],[75,78,40,40],[82,82,40,60],[75,79,40,51],[75,75,48,45],[77,81,48,39],[77,71,46,45],
             [77,76,40,45],[73,75,49,52],[79,85,47,50],[79,77,44,56],[83,77,41,49],[83,72,47,44],[83,79,53,44],[83,85,45,45],[84,81,57,45],[84,76,48,45],
             [77,75,53,38],[80,71,50,41],[76,82,54,39],[81,74,41,44],[81,81,49,48],[78,75,39,45],[86,83,51,43],[78,77,52,43],[78,86,47,52],[75,73,41,44],
             [79,84,50,42],[84,75,47,42],[75,81,49,43],[78,80,51,54],[84,73,45,49],[83,81,43,48],[76,80,39,43],[83,77,63,52],[79,82,47,44],[81,79,45,45],
             [85,85,52,45],[81,79,50,53],[72,86,50,40],[72,84,40,39],[84,80,42,42],[81,82,45,42],[80,72,53,36],[86,78,46,42],[73,79,48,39],[85,79,44,37],
             [81,82,56,42],[87,79,55,62],[83,75,51,39],[82,83,39,57],[71,79,50,47],[80,85,47,39],[81,87,52,40],[79,78,52,40],[80,82,43,42],[77,80,56,40],
             [79,77,50,55],[73,83,50,47],[84,79,57,42],[73,83,47,39],[74,82,52,38],[71,78,46,39],[78,79,44,44],[76,86,51,38],[74,75,48,40],[77,75,62,37],
             [77,74,46,37],[71,80,59,41],[82,85,44,45],[75,77,47,37],[78,76,56,47],[76,75,54,39],[72,79,45,62],[74,83,47,38],[70,80,63,41],[74,77,49,37],
             [68,79,47,38],[65,66,49,42],[75,66,57,35],[72,78,49,33],[70,70,51,37],[63,81,50,36],[58,69,44,35],[66,74,56,37],[72,77,57,34],[68,75,48,45],
             [76,70,55,47],[57,73,47,36],[74,75,49,36],[62,67,51,44],[66,65,45,39],[70,72,45,43],[66,73,45,44],[68,68,49,38],[75,72,43,39],[64,69,53,45],
             [64,79,49,38],[63,70,51,40],[55,60,61,38],[70,78,53,48],[70,76,47,34],[65,75,43,43],[81,75,65,40],[61,65,59,35],[58,69,58,36],[79,74,53,36],
             [67,69,43,36],[70,76,51,39],[55,60,67,51],[61,65,55,43],[66,72,45,36],[68,81,49,35],[63,66,53,37],[68,73,60,49],[57,68,62,47],[55,69,59,53],
             [64,67,78,41],[60,69,55,49],[61,67,58,45],[57,71,63,53],[70,82,63,40],[66,66,51,51],[62,70,56,42],[59,63,70,41],[73,73,59,53],[72,83,54,45],
             [66,68,59,36],[71,71,68,44],[59,66,60,40],[56,69,64,53],[57,66,61,45],[66,73,56,43],[65,82,58,43],[66,70,55,43],[62,63,58,42],[75,66,68,58],
             [74,72,61,54],[72,73,61,49],[66,69,60,46],[63,69,60,52],[69,75,61,47],[60,77,55,50],[68,68,63,39],[66,74,71,48],[59,82,62,57],[82,75,61,50],
             [70,71,57,49],[61,72,57,42],[71,69,55,45],[59,65,63,46],[61,69,67,53],[62,78,63,51],[66,79,60,47],[62,79,60,51],[69,80,65,55],[67,73,66,47],
             [74,63,60,45],[63,63,57,58],[77,63,61,46],[55,67,72,43],[64,78,58,51],[64,69,60,45],[68,73,60,42],[60,67,56,45],[71,70,60,57],[64,67,66,49],
             [61,66,67,67],[61,67,70,43],[61,67,61,47],[67,75,60,40],[78,67,65,60],[66,70,60,42],[63,69,63,51],[66,65,59,51],[66,65,66,54],[67,65,68,51],
             [59,65,63,62],[61,69,62,62],[56,68,65,61],[60,68,59,45],[78,72,63,52],[60,66,57,50],[63,69,59,51],[52,72,62,63],[51,65,63,42],[60,75,62,43],
             [58,77,63,55],[66,64,78,43],[71,66,61,47],[57,64,73,60],[51,75,60,50],[61,69,61,46],[78,68,53,48],[60,66,63,57],[57,74,59,67],[61,60,78,67],
             [60,58,68,53],[57,66,65,49],[83,63,73,51],[60,72,73,65],[63,66,69,49],[63,77,61,63],[62,69,59,47],[72,79,61,50],[76,77,64,55],[55,79,81,55],
             [58,77,69,55],[56,65,65,53],[65,76,63,56],[65,73,70,44],[63,63,66,58],[68,65,80,72],[61,58,70,55],[71,60,71,56],[63,63,70,50],[62,65,63,49],
             [55,66,66,52],[54,66,70,51],[63,65,69,58],[51,62,69,56],[56,70,72,49],[80,71,65,55],[62,74,64,53],[64,63,67,63],[55,59,62,63],[58,66,71,56],
             [71,79,65,59],[67,78,72,49],[64,67,66,59],[67,61,72,57],[52,73,70,52],[64,76,73,63],[61,71,68,47],[59,78,66,58],[57,70,75,63],[67,69,65,56],
             [54,69,66,60],[59,72,67,72],[56,60,82,64],[57,57,70,55],[58,70,74,55],[71,78,69,60],[58,81,67,70],[62,61,66,55],[64,81,64,56],[61,69,77,68],
             [72,63,74,56],[72,67,77,55],[70,75,74,56],[66,63,69,71],[67,66,73,57],[56,58,73,62],[63,68,64,62],[60,64,73,61],[65,67,65,57],[65,62,69,59],
             [60,60,66,55],[67,81,68,65],[54,76,70,58],[54,62,67,69],[62,77,67,69],[56,67,65,51],[57,68,69,57],[57,64,76,69],[63,58,76,57],[60,62,79,56],
             [70,67,74,54],[51,67,63,58],[66,67,69,67],[60,68,74,59],[58,56,74,56],[70,65,68,60],[63,76,66,59],[73,66,69,50],[62,64,74,60],[69,63,73,58],
             [58,64,75,66],[58,58,75,64],[51,67,86,60],[55,67,76,52],[65,75,71,76],[70,61,68,65],[60,63,71,59],[54,60,78,60],[50,61,74,65],[67,64,76,57],
             [56,60,73,72],[61,65,69,61],[59,59,76,68],[54,55,73,72],[61,62,70,64],[61,60,75,60],[60,62,76,73],[67,61,78,56],[57,64,74,59],[66,62,71,57],
             [54,57,82,68],[54,60,69,68],[60,70,75,70],[47,73,77,59],[55,72,65,57],[63,69,76,58],[51,62,76,56],[53,56,68,60],[51,59,73,57],[65,63,69,66],
             [60,74,69,75],[53,61,72,60],[68,57,72,62],[58,67,73,63],[58,66,73,63],[58,67,74,60],[55,73,71,71],[53,69,73,70],[52,65,73,67],[52,65,74,70],
             [64,55,73,61],[64,59,71,72],[46,63,88,69],[47,68,74,61],[61,80,75,58],[62,59,74,55],[51,58,69,57],[56,58,80,78],[49,64,84,65],[63,70,77,68],
             [65,69,70,57],[51,57,79,67],[56,60,73,70],[49,70,78,63],[58,56,81,67],[57,54,75,68],[60,63,70,76],[61,63,75,75],[63,69,79,66],[67,61,72,68],
             [60,57,76,67],[61,65,75,62],[48,54,78,61],[49,54,75,56],[67,67,82,66],[50,57,76,61],[51,58,74,58],[52,62,82,64],[48,60,76,61],[48,61,77,72],
             [58,61,71,58],[58,62,67,57],[55,60,72,64],[60,59,75,59],[57,54,72,63],[52,61,75,62],[59,57,75,69],[54,55,77,61],[53,54,78,61],[54,58,78,65],
             [55,56,75,61],[51,57,71,60],[58,62,78,69],[48,55,75,57],[45,55,78,72],[60,66,77,55],[58,59,70,59],[62,57,71,62],[50,55,76,66],[42,54,79,59],
             [48,58,73,60],[57,54,74,66],[59,61,71,72],[51,65,83,61],[53,49,74,69],[48,54,70,66],[48,51,73,69],[43,59,74,66],[48,55,75,69],[46,57,76,71],
             [52,54,77,70],[49,57,69,68],[50,47,74,58],[46,54,76,66],[54,54,75,60],[49,66,77,67],[54,45,73,73],[54,55,73,61],[49,52,72,55],[46,53,71,72],
             [46,57,78,74],[53,55,79,64],[54,54,71,64],[53,47,71,62],[46,58,69,57],[56,47,75,63],[55,49,75,64],[52,48,76,69],[46,62,78,63],[45,56,77,61],
             [50,48,80,67],[51,52,77,63],[40,51,79,61],[42,50,77,59],[57,57,75,66],[47,53,74,69],[47,48,67,66],[42,53,73,76],[42,54,76,59],[44,54,82,62],
             [45,43,73,65],[53,49,75,77],[46,52,75,59],[45,49,70,65],[54,48,71,55],[50,63,74,60],[44,60,76,63],[45,51,75,66],[56,45,73,68],[50,46,76,66],
             [58,42,69,63],[42,48,72,62],[49,44,79,61],[44,43,84,61],[48,47,80,61],[50,51,73,61],[44,48,77,66],[46,43,73,64],[42,47,72,65],[36,48,70,69],
             [43,57,81,68],[45,59,85,70],[46,57,75,56],[41,47,77,55],[46,45,74,60],[51,47,71,63],[52,43,74,63],[45,49,80,73],[43,47,75,72],[40,45,71,61],
             [40,42,66,63],[45,50,68,74],[35,40,71,63],[34,39,74,75],[36,39,75,66],[47,45,77,64],[51,44,70,62],[45,49,73,57],[41,45,76,68],[42,45,73,60],
             [39,45,72,67],[34,41,71,64],[43,48,67,63],[39,40,67,61],[49,59,67,66],[43,46,73,60],[41,42,71,62],[38,41,74,59],[40,40,76,59],[44,35,72,58],
             [40,42,66,63],[45,50,68,74],[35,40,71,63],[34,39,74,75],[36,39,75,66],[47,45,77,64],[51,44,70,62],[45,49,73,57],[41,45,76,68],[42,45,73,60],
             [39,45,72,67],[34,41,71,64],[43,48,67,63],[39,40,67,61],[49,59,67,66],[43,46,73,60],[41,42,71,62],[38,41,74,59],[40,40,76,59],[44,35,72,58],
             [50,36,63,69],[43,45,71,72],[49,36,70,76],[42,52,72,76],[43,40,75,76],[41,56,82,78],[40,39,77,72],[36,40,74,71],[51,36,74,71],[48,46,64,76],
             [48,37,71,78],[41,42,69,69],[34,43,77,71],[39,40,83,65],[37,41,74,70],[41,38,73,75],[43,43,67,79],[41,35,71,75],[48,45,63,75],[39,37,71,80],
             [42,42,70,79],[51,36,84,77],[53,55,77,74],[55,38,68,78],[39,47,71,81],[38,45,68,77],[37,35,79,77],[41,36,68,74],[42,42,64,72],[47,38,65,75],
[46,36,69,72],
[43,53,66,72],
[38,48,75,68],
[38,40,69,74],
[38,36,74,74],
[43,37,61,73],
[55,39,63,69],
[46,41,69,70],
[44,47,68,73],
[44,41,65,81],
[43,52,67,76],
[42,40,72,78],
[43,39,64,70],
[42,44,73,72],
[41,43,72,83],
[44,34,75,75],
[40,40,67,76],
[39,34,81,79],
[55,38,67,79],
[44,42,74,78],
[47,35,63,75],
[46,45,67,73],
[37,40,70,76],
[37,45,73,78],
[36,35,66,74],
[42,39,72,73],
[45,40,64,75],
[56,50,63,79],
[51,55,65,75],
[54,48,66,77]];


var prediction = [1,
1,
1,
1,
1,
1,
1,
1,
1,
1,
1,
1,
1,
1,
1,
1,
1,
1,
1,
1,
2,
2,
2,
2,
2,
2,
2,
2,
2,
2,
2,
2,
2,
2,
2,
2,
2,
2,
2,
2,
3,
3,
3,
3,
3,
3,
3,
3,
3,
3,
3,
3,
3,
3,
3,
3,
3,
3,
3,
3,
4,
4,
4,
4,
4,
4,
4,
4,
4,
4,
4,
4,
4,
4,
4,
4,
4,
4,
4,
4,
5,
5,
5,
5,
5,
5,
5,
5,
5,
5,
5,
5,
5,
5,
5,
5,
5,
5,
5,
5,
6,
6,
6,
6,
6,
6,
6,
6,
6,
6,
6,
6,
6,
6,
6,
6,
6,
6,
6,
6,
7,
7,
7,
7,
7,
7,
7,
7,
7,
7,
7,
7,
7,
7,
7,
7,
7,
7,
7,
7,
8,
8,
8,
8,
8,
8,
8,
8,
8,
8,
8,
8,
8,
8,
8,
8,
8,
8,
8,
8,
9,
9,
9,
9,
9,
9,
9,
9,
9,
9,
9,
9,
9,
9,
9,
9,
9,
9,
9,
9,
10,
10,
10,
10,
10,
10,
10,
10,
10,
10,
10,
10,
10,
10,
10,
10,
10,
10,
10,
10,
11,
11,
11,
11,
11,
11,
11,
11,
11,
11,
11,
11,
11,
11,
11,
11,
11,
11,
11,
11,
12,
12,
12,
12,
12,
12,
12,
12,
12,
12,
12,
12,
12,
12,
12,
12,
12,
12,
12,
12,
13,
13,
13,
13,
13,
13,
13,
13,
13,
13,
13,
13,
13,
13,
13,
13,
13,
13,
13,
13,
14,
14,
14,
14,
14,
14,
14,
14,
14,
14,
14,
14,
14,
14,
14,
14,
14,
14,
14,
14,
15,
15,
15,
15,
15,
15,
15,
15,
15,
15,
15,
15,
15,
15,
15,
15,
15,
15,
15,
15,
16,
16,
16,
16,
16,
16,
16,
16,
16,
16,
16,
16,
16,
16,
16,
16,
16,
16,
16,
16,
17,
17,
17,
17,
17,
17,
17,
17,
17,
17,
17,
17,
17,
17,
17,
17,
17,
17,
17,
17,
18,
18,
18,
18,
18,
18,
18,
18,
18,
18,
18,
18,
18,
18,
18,
18,
18,
18,
18,
18,
19,
19,
19,
19,
19,
19,
19,
19,
19,
19,
19,
19,
19,
19,
19,
19,
19,
19,
19,
19,
20,
20,
20,
20,
20,
20,
20,
20,
20,
20,
20,
20,
20,
20,
20,
20,
20,
20,
20,
20,
21,
21,
21,
21,
21,
21,
21,
21,
21,
21,
21,
21,
21,
21,
21,
21,
21,
21,
21,
21,
22,
22,
22,
22,
22,
22,
22,
22,
22,
22,
22,
22,
22,
22,
22,
22,
22,
22,
22,
22,
23,
23,
23,
23,
23,
23,
23,
23,
23,
23,
23,
23,
23,
23,
23,
23,
23,
23,
23,
23,
24,
24,
24,
24,
24,
24,
24,
24,
24,
24,
24,
24,
24,
24,
24,
24,
24,
24,
24,
24,
25,
25,
25,
25,
25,
25,
25,
25,
25,
25,
25,
25,
25,
25,
25,
25,
25,
25,
25,
25,
26,
26,
26,
26,
26,
26,
26,
26,
26,
26,
26,
26,
26,
26,
26,
26,
26,
26,
26,
26,
27,
27,
27,
27,
27,
27,
27,
27,
27,
27,
27,
27,
27,
27,
27,
27,
27,
27,
27,
27,
28,
28,
28,
28,
28,
28,
28,
28,
28,
28,
28,
28,
28,
28,
28,
28,
28,
28,
28,
28,
29,
29,
29,
29,
29,
29,
29,
29,
29,
29,
29,
29,
29,
29,
29,
29,
29,
29,
29,
29,
30,
30,
30,
30,
30,
30,
30,
30,
30,
30,
30,
30,
30,
30,
30,
30,
30,
30,
30,
30,
31,
31,
31,
31,
31,
31,
31,
31,
31,
31,
31,
31,
31,
31,
31,
31,
31,
31,
31,
31,
32,
32,
32,
32,
32,
32,
32,
32,
32,
32,
32,
32,
32,
32,
32,
32,
32,
32,
32,
32,
33,
33,
33,
33,
33,
33,
33,
33,
33,
33,
33,
33,
33,
33,
33,
33,
33,
33,
33,
33,
34,
34,
34,
34,
34,
34,
34,
34,
34,
34,
34,
34,
34,
34,
34,
34,
34,
34,
34,
34,
35,
35,
35,
35,
35,
35,
35,
35,
35,
35,
35,
35,
35,
35,
35,
35,
35,
35,
35,
35,
36,
36,
36,
36,
36,
36,
36,
36,
36,
36,
36,
36,
36,
36,
36,
36,
36,
36,
36,
36,
37,
37,
37,
37,
37,
37,
37,
37,
37,
37,
37,
37,
37,
37,
37,
37,
37,
37,
37,
37,
38,
38,
38,
38,
38,
38,
38,
38,
38,
38,
38,
38,
38,
38,
38,
38,
38,
38,
38,
38,
39,
39,
39,
39,
39,
39,
39,
39,
39,
39,
39,
39,
39,
39,
39,
39,
39,
39,
39,
39,
40,
40,
40,
40,
40,
40,
40,
40,
40,
40,
40,
40,
40,
40,
40,
40,
40,
40,
40,
40,
41,
41,
41,
41,
41,
41,
41,
41,
41,
41,
41,
41,
41,
41,
41,
41,
41,
41,
41,
41,
42,
42,
42,
42,
42,
42,
42,
42,
42,
42,
42,
42,
42,
42,
42,
42,
42,
42,
42,
42,
43,
43,
43,
43,
43,
43,
43,
43,
43,
43,
43,
43,
43,
43,
43,
43,
43,
43,
43,
43,
44,
44,
44,
44,
44,
44,
44,
44,
44,
44,
44,
44,
44,
44,
44,
44,
44,
44,
44,
44,
45,
45,
45,
45,
45,
45,
45,
45,
45,
45,
45,
45,
45,
45,
45,
45,
45,
45,
45,
45,
46,
46,
46,
46,
46,
46,
46,
46,
46,
46,
46,
46,
46,
46,
46,
46,
46,
46,
46,
46,
47,
47,
47,
47,
47,
47,
47,
47,
47,
47,
47,
47,
47,
47,
47,
47,
47,
47,
47,
47];
knn.train(train, prediction);
var sp;
sp = new SerialPort.SerialPort(portName, portConfig);


//Create a packet to be sent to all other XBEE units on the PAN.
// The value of 'data' is meaningless, for now.
var RSSIRequestPacket = {
  type: C.FRAME_TYPE.ZIGBEE_TRANSMIT_REQUEST,
  destination64: "000000000000ffff",
  broadcastRadius: 0x01,
  options: 0x00,
  data: "test"
}

var requestRSSI = function(){
  sp.write(XBeeAPI.buildFrame(RSSIRequestPacket));
}

sp.on("open", function () {
  console.log('open');
  requestRSSI();
  setInterval(requestRSSI, sampleDelay);
});


XBeeAPI.on("frame_object", function(frame) {
  if (frame.type == 144)
  {
    switch(frame.data[1])
    {
      case 1:
              if(flag[0] != 1)
              {
                dataset[0][0] = frame.data[0];
                count++;
              }
              break;
      case 2:
              if(flag[1] != 1)
              {
                dataset[0][1] = frame.data[0];
                count++;
              }
              break;
      case 3:
              if(flag[2] != 1)
              {
                dataset[0][2] = frame.data[0];
                count++;
              }     
              break;           
      case 4:
              if(flag[3] != 1)
              {
                dataset[0][3] = frame.data[0];
                count++;
              }
              break;
    }
    if(count == 4)
    {
      console.log(dataset);
      var ans = knn.predict(dataset);
      console.log(ans);
      //writer.write({data: data});
      flag = [0,0,0,0];
      count = 0;
      //c++
    }
  }
});
